class Book < ApplicationRecord
  has_many :reviews
  has_many :book_authors
  has_many :authors, through: :book_authors

  validates :title, presence: true
  validates :pages, presence: true
  validates :year_pub, presence: true
  #validates :publisher, presence: true
  # validates :image, presence: true

  after_initialize :init

    def init
      self.image  ||= "data:image/jpeg;base64,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"  # will set the default value only if it's nil
    end

  def avg_score
    if self.reviews.count == 0
      0
    else
      self.reviews.average(:score)
    end
  end

  def self.select_sort(option)
    if option == "avg_rating_asc"
      self.left_joins(:reviews).group(:id).order("avg(reviews.score) asc nulls first, books.title asc")
    elsif option == "avg_rating_desc"
      self.left_joins(:reviews).group(:id).order("avg(reviews.score) desc nulls last, books.title asc")
    elsif option == "num_pages_asc"
      self.order(:pages)
    elsif option == "num_pages_desc"
      self.order(pages: :desc)
    elsif option == "num_reviews_asc"
      left_joins(:reviews)
      .group(:id)
      .order("reviews.count asc, books.title asc")
    elsif option == "num_reviews_desc"
      left_joins(:reviews)
      .group(:id)
      .order("reviews.count desc, books.title asc")
    end
  end

  def self.top_books
    joins(:reviews).group(:id).order("avg(reviews.score) desc, books.title asc")
  end

  def self.worst_books
    joins(:reviews).group(:id).order("avg(reviews.score) asc, books.title asc")
  end

  def top_reviews
    # binding.pry
    self.reviews.order(score: :desc).limit(3)
    # binding.pry
  end

end
